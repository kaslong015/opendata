{% load static %}
<!DOCTYPE html>
<html>
<head>
  <title>Africa Geoportal + Django Coordinates</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <style>
    html, body, #esriMap {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
    }
  </style>
  <script src="https://js.arcgis.com/4.29/"></script>
</head>
<body>
 
 <!-- Coordinate Search Box -->
<div style="margin-bottom: 10px;">
  <input type="number" id="lat" placeholder="Latitude" step="0.0001">
  <input type="number" id="lng" placeholder="Longitude" step="0.0001">
  <button onclick="searchByCoordinates()">Search</button>
</div>

<!-- ESRI Map Container -->
<!-- <div id="esriMap" style="height: 600px;"></div> -->
<div id="esriMap"></div>
<script>
  const polygons = []; // Will store polygon geometries with ID
  let view;            // Global MapView

  require([
    "esri/WebMap",
    "esri/views/MapView",
    "esri/Graphic",
    "esri/layers/GraphicsLayer",
    "esri/geometry/geometryEngine",
    "esri/geometry/Point"
  ], function(WebMap, MapView, Graphic, GraphicsLayer, geometryEngine, Point) {

    const webmap = new WebMap({
      portalItem: {
        id: "86ed11bd00ab4a8c9de6263afe0cd4ed"
      }
    });

    view = new MapView({
      container: "esriMap",
      map: webmap,
      center: [9.560139, 10.891986],
      zoom: 6
    });

    const graphicsLayer = new GraphicsLayer();
    webmap.add(graphicsLayer);

    const greenColors = [
      '#28a745', '#4CAF50', '#388E3C', '#8BC34A', '#4CAF50',
      "#FF0000", "#FF6347", "#FF4500", "#DC143C", "#B22222",
      "#8B0000", "#FF7F7F", "#FA8072"
    ];

    fetch("{% url 'load_coordinates' %}")
      .then(response => response.json())
      .then(data => {
        let colorIndex = 0;

        for (const id in data) {
          if (data.hasOwnProperty(id)) {
            const rings = data[id].map(pt => [pt.lng, pt.lat]);

            const polygon = {
              type: "polygon",
              rings: [rings],
              spatialReference: { wkid: 4326 }
            };

            const color = greenColors[colorIndex % greenColors.length];
            colorIndex++;

            const graphic = new Graphic({
              geometry: polygon,
              symbol: {
                type: "simple-fill",
                color: color + "88",
                outline: {
                  color: color,
                  width: 1
                }
              },
              attributes: { id: id },
              popupTemplate: {
                title: "Polygon ID: {id}"
              }
            });

            polygons.push({ id: id, geometry: graphic.geometry });
            graphicsLayer.add(graphic);
          }
        }
      })
      .catch(error => console.error("Polygon load error:", error));

    window.searchByCoordinates = function () {
      const lat = parseFloat(document.getElementById("lat").value);
      const lng = parseFloat(document.getElementById("lng").value);

      if (isNaN(lat) || isNaN(lng)) {
        alert("Please enter valid coordinates.");
        return;
      }

      const point = new Point({
        latitude: lat,
        longitude: lng
      });

      // Check which polygon contains the point
      let found = false;
      for (const poly of polygons) {
        if (geometryEngine.contains(poly.geometry, point)) {
          found = true;

          view.popup.open({
            title: "Found in Polygon",
            content: "ID: " + poly.id,
            location: point
          });

          view.goTo({ center: [lng, lat], zoom: 12 });
          break;
        }
      }

      if (!found) {
        view.popup.open({
          title: "No polygon found",
          content: `Point (${lat}, ${lng}) is not inside any polygon.`,
          location: point
        });

        view.goTo({ center: [lng, lat], zoom: 12 });
      }
    }
  });
</script>

</body>
</html>





